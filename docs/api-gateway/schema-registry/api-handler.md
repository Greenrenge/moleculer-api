# API Handler

#### B. API Handler

**Dynamic Handler**

동적 핸들러는 웹 서버의 모든 base 경로를 관리하며, 미들웨어 및 플러그인, 엔드포인트 간의 경로 충돌을 방지합니다. 동적 핸들러는 조건에 따라 브랜치 핸들러 및 버전 핸들러를 생성 및 삭제하며 동적으로 라우트 테이블을 구성합니다.

동적 핸들러는 클라이언트의 요청에 따라 미들웨어를 수행하고, 브랜치 핸들러로 요청을 프록시합니다.

**Branch Handler**

브랜치 핸들러는 태그에 따라 버전 핸들러로 요청을 프록시합니다.

이 브랜치 핸들러들은 아래의 규칙에 따라 삭제됩니다.

* `master` 브랜치를 제외하고, 60분 이상 실행되지 않는 브랜치 핸들러는 삭제됩니다.

**Version Handler**

서비스 API 스키마의 병합이 일어날 때마다 새로운 버전의 Gateway API 스키마가 생성됩니다. 병합에 성공한 Gateway API 스키마는 `latest` 및 숏해시로 태그됩니다. 그리고 업데이트된 엔드포인트별로 스키마, 프로토콜 플러그인, 커넥터를 연결해 각 핸들러를 생성합니다. 업데이트되지 않은 스키마의 핸들러는 가능한 재참조됩니다.

이 버전 핸들러들은 아래의 규칙에 따라 삭제됩니다.

* 10개를 초과\(기본값\)하는 버전이 존재한는 경우 오래된 순으로 버전 핸들러가 삭제됩니다. 

**Non-Persistence**

API 스키마의 브랜치 및 태그 기능은 버전 관리\(/v1, /v2 같은\)가 아닌 분산 환경에서의 개발 편의를 위해 개발되었습니다.

주의사항

* Gateway에는 Persistence Layer가 존재하지 않습니다.
* Gateway 재시작시 브랜치, 버전 및 태그 정보가 복원되지 않습니다.
* Gateway 노드간에 데이터 동기화 전략이 존재하지 않습니다.
* Gateway 노드간에 서비스 API 스키마 병합의 순서가 동일하게 보장되지 않습니다.

하지만 Gateway 재시작 이후 모든 서비스들에 대한 `discover`가 진행되면서 자연스럽게 각 브랜치의 `latest` 버전에는 최신 Gateway API 스키마가 복원됩니다. 각 브랜치의 `latest` 버전의 신뢰성은 보장됩니다.

